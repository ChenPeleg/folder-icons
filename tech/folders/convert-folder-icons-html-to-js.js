// Converts folder icons from HTML (data-association attributes) into JSON and JS modules
// Input: tech/folders/folder-icons-as-html-from-site.html
// Outputs:
//  - tech/folders/folder-icons.generated.json
//  - tech/folders/folder-icons.generated.js

const fs = require('fs');
const path = require('path');

const INPUT_HTML = path.resolve(__dirname, 'folder-icons-as-html-from-site.html');
const OUT_JSON = path.resolve(__dirname, 'folder-icons.generated.json');
const OUT_JS = path.resolve(__dirname, 'folder-icons.generated.js');

function htmlDecode(str) {
  if (!str) return str;
  // Minimal decode for common entities seen in the source
  return str
    .replace(/&quot;/g, '"')
    .replace(/&#34;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&apos;/g, "'")
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>');
}

function main() {
  if (!fs.existsSync(INPUT_HTML)) {
    console.error('Input HTML not found:', INPUT_HTML);
    process.exit(1);
  }

  const html = fs.readFileSync(INPUT_HTML, 'utf8');

  const re = /data-association="([^"]+)"/g; // capture attribute value
  const icons = [];
  let match;
  let index = 0;

  while ((match = re.exec(html)) !== null) {
    const attrIndex = match.index;

    // Determine the start and end of the enclosing tag to check its attributes
    const tagStart = html.lastIndexOf('<div', attrIndex);
    const tagEnd = html.indexOf('>', attrIndex);
    if (tagStart === -1 || tagEnd === -1) {
      index++;
      continue;
    }
    const tagOpen = html.slice(tagStart, tagEnd + 1);

    // Only keep entries where data-category="folders" (quotes optional)
    const isFolder = /data-category\s*=\s*("folders"|'folders'|folders)/i.test(tagOpen);
    if (!isFolder) {
      index++;
      continue;
    }

    const encoded = match[1];
    const decoded = htmlDecode(encoded);
    try {
      const obj = JSON.parse(decoded);
      if (!obj || typeof obj !== 'object') {
        index++;
        continue; // skip null or non-object
      }
      // Basic sanity checks and normalization
      if (typeof obj.priority === 'string' && /^\d+$/.test(obj.priority)) {
        obj.priority = Number(obj.priority);
      }
      icons.push(obj);
    } catch (e) {
      // Provide a short context snippet to help debugging without spamming logs
      console.warn(`Skipping entry #${index} due to JSON parse error`);
      try {
        console.warn(String(decoded).slice(0, 200) + (String(decoded).length > 200 ? 'â€¦' : ''));
      } catch {}
    }
    index++;
  }

  // Deduplicate exact duplicates (same name + icon + pattern + type)
  const seen = new Set();
  const unique = [];
  for (const it of icons) {
    const key = [it.name, it.icon, it.pattern, it.type, it.folderNames].join('|');
    if (!seen.has(key)) {
      seen.add(key);
      unique.push(it);
    }
  }

  // Sort by priority desc, then name asc for stable order (optional)
  unique.sort((a, b) => {
    const pa = typeof a.priority === 'number' ? a.priority : -Infinity;
    const pb = typeof b.priority === 'number' ? b.priority : -Infinity;
    if (pb !== pa) return pb - pa;
    const na = (a.name || '').toLowerCase();
    const nb = (b.name || '').toLowerCase();
    if (na < nb) return -1;
    if (na > nb) return 1;
    return 0;
  });

  // Write JSON
  fs.writeFileSync(OUT_JSON, JSON.stringify(unique, null, 2) + '\n', 'utf8');

  // Write JS ESM module
  const js = `// Auto-generated by convert-folder-icons-html-to-js.js on ${new Date().toISOString()}
// Do not edit manually. Source of truth: tech/folders/folder-icons-as-html-from-site.html
export const folderIcons = ${JSON.stringify(unique, null, 2)};
export default folderIcons;
`;
  fs.writeFileSync(OUT_JS, js, 'utf8');

  console.log(`Parsed ${icons.length} folder entries, wrote ${unique.length} unique folder icons.`);
  console.log('JSON:', path.relative(process.cwd(), OUT_JSON));
  console.log('JS:  ', path.relative(process.cwd(), OUT_JS));
}

if (require.main === module) {
  try {
    main();
  } catch (err) {
    console.error(err);
    process.exit(1);
  }
}
